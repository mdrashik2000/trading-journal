<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RashikTrades | Professional Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { /* Dynamic */ }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-app: #f3f4f6; --bg-panel: #ffffff; --border-color: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --accent-color: #4f46e5; --accent-bg: rgba(79, 70, 229, 0.1);
            --input-bg: #f9fafb; --cal-bg: #ffffff; --cal-border: 1px solid #e5e7eb;
            --success: #10b981; --danger: #ef4444; 
            --win-bg: rgba(16, 185, 129, 0.15); --loss-bg: rgba(239, 68, 68, 0.15); --be-bg: rgba(148, 163, 184, 0.15);
        }
        .midnight {
            --bg-app: #0f172a; --bg-panel: #1e293b; --border-color: #334155;
            --text-primary: #f8fafc; --text-secondary: #94a3b8;
            --accent-color: #6366f1; --accent-bg: rgba(99, 102, 241, 0.15);
            --input-bg: #0f172a; --cal-bg: #334155; --cal-border: none;
            --win-bg: rgba(16, 185, 129, 0.15); --loss-bg: rgba(239, 68, 68, 0.15); --be-bg: rgba(148, 163, 184, 0.15);
        }
        .dark {
            --bg-app: #000000; --bg-panel: #09090b; --border-color: #27272a;
            --text-primary: #e4e4e7; --text-secondary: #a1a1aa;
            --accent-color: #3b82f6; --accent-bg: rgba(59, 130, 246, 0.15);
            --input-bg: #18181b; --cal-bg: #18181b; --cal-border: 1px solid #27272a;
            --win-bg: rgba(16, 185, 129, 0.2); --loss-bg: rgba(239, 68, 68, 0.2); --be-bg: rgba(148, 163, 184, 0.2);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-primary); transition: all 0.2s; height: 100vh; overflow: hidden; }
        
        /* Sidebar Responsive Logic */
        .sidebar { background-color: var(--bg-panel); border-right: 1px solid var(--border-color); transition: transform 0.3s ease; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 50; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .overlay { display: none; }
            .overlay.active { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        }

        .header { background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); }
        .card { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--accent-color); color: white; transition: 0.2s; } .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); } .btn-secondary:hover { background-color: var(--border-color); color: var(--text-primary); }
        .form-input { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; width: 100%; outline: none; font-size: 0.875rem; }
        .form-input:focus { border-color: var(--accent-color); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; transition: 0.2s; }
        .nav-item:hover { background-color: var(--border-color); color: var(--text-primary); }
        .nav-item.active { background-color: var(--accent-bg); color: var(--accent-color); border-right: 3px solid var(--accent-color); }
        
        table { width: 100%; border-collapse: collapse; min-width: 100%; }
        th { text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        td { padding: 12px 16px; font-size: 0.85rem; border-bottom: 1px solid var(--border-color); color: var(--text-primary); white-space: nowrap; vertical-align: middle; height: 50px; }
        tr:hover { background-color: var(--input-bg); }
        
        .bdt-wrapper { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 0 8px; }
        .bdt-label { font-size: 10px; color: var(--text-secondary); font-weight: bold; margin-right: 5px; white-space: nowrap; }
        .bdt-input { background: transparent; border: none; width: 40px; color: var(--accent-color); font-weight: bold; font-size: 12px; outline: none; text-align: center; }
        
        .sub-curr { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; font-weight: 700; opacity: 0.9; }
        .cal-box { background-color: var(--cal-bg); border: var(--cal-border); border-radius: 8px; min-height: 90px; position: relative; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; padding: 8px; }
        .cal-win { background-color: var(--win-bg) !important; } .cal-loss { background-color: var(--loss-bg) !important; } .cal-be { background-color: var(--be-bg) !important; }
        .res-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); color: white; }
        .res-win { background-color: #10b981; } .res-loss { background-color: #ef4444; } .res-be { background-color: #6b7280; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .chart-btn-active { background-color: var(--accent-bg); color: var(--accent-color); border: 1px solid var(--accent-color); }

        /* Growth Specific Styles */
        .stage-header { padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .stage-1 { background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6; }
        .stage-2 { background: rgba(168, 85, 247, 0.05); border-left: 4px solid #a855f7; }
        .stage-3 { background: rgba(16, 185, 129, 0.05); border-left: 4px solid #10b981; }
        .table-pro th { padding: 8px 12px; font-size: 0.65rem; }
        .table-pro td { padding: 6px 12px; font-size: 0.8rem; height: auto; }
        .g-input { font-weight: bold; color: var(--accent-color); text-align: center; }
        
        .btn-toggle { flex:1; padding: 6px 0; text-align: center; border-radius: 6px; font-size: 0.75rem; font-weight: 700; transition: 0.2s; color: var(--text-secondary); }
        .btn-toggle-active { background-color: var(--bg-panel); color: var(--accent-color); shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-toggle-active-deposit { background-color: var(--bg-panel); color: var(--success); }
        .btn-toggle-active-withdraw { background-color: var(--bg-panel); color: var(--danger); }
    </style>
</head>
<body class="flex">

    <div id="mobile-overlay" class="overlay hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="sidebar w-64 flex flex-col justify-between flex-shrink-0 z-50">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-[var(--border-color)]">
                <div class="w-8 h-8 rounded bg-[var(--accent-color)] flex items-center justify-center text-white font-bold mr-3 shadow-lg">R</div>
                <div><h1 class="font-bold text-sm tracking-wide">RashikTrades</h1><p class="text-[10px] text-[var(--text-secondary)] uppercase">Trading Journal</p></div>
            </div>
            <nav class="p-4 mt-2">
                <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-layer-group w-4 text-center"></i> Dashboard</div>
                <div onclick="switchTab('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-alt w-4 text-center"></i> Calendar</div>
                <div onclick="switchTab('growth')" id="nav-growth" class="nav-item"><i class="fas fa-rocket w-4 text-center"></i> Growth Plan</div>
            </nav>
        </div>
        <div class="p-4 border-t border-[var(--border-color)]">
            <div class="card p-3 flex items-center gap-3 bg-[var(--accent-bg)] border-[var(--accent-color)] border-opacity-20">
                <div class="text-[var(--accent-color)] text-lg"><i class="fas fa-user-circle"></i></div><div><p class="text-xs font-bold">Rashik</p></div>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-full overflow-hidden bg-[var(--bg-app)]">
        
        <header class="header h-16 flex items-center justify-between px-6 flex-shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-[var(--text-secondary)]"><i class="fas fa-bars"></i></button>
                <h2 class="text-lg font-bold" id="page-title">Dashboard Overview</h2>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="togglePrivacy()" id="btn-privacy" class="btn-secondary w-9 h-9 rounded-lg flex items-center justify-center text-[var(--accent-color)] border-[var(--accent-color)]" title="Toggle PnL"><i class="fas fa-eye"></i></button>
                <div class="h-6 w-[1px] bg-[var(--border-color)] mx-1 hidden sm:block"></div>
                <div class="bdt-wrapper hidden sm:flex"><span class="bdt-label">1 USDT = ৳</span><input type="number" id="bdt-rate" class="bdt-input" value="125" oninput="updateBDT(this.value)"></div>
                <div class="h-6 w-[1px] bg-[var(--border-color)] mx-1 hidden sm:block"></div>
                <div id="dashboard-controls" class="flex gap-2">
                    <select onchange="updateDashboardFilter(this.value)" id="dashboard-filter" class="form-input py-1.5 px-3 w-32 text-xs font-bold cursor-pointer"><option value="THIS_MONTH">This Month</option><option value="LAST_MONTH">Last Month</option><option value="ALL">All Time</option></select>
                </div>
                <select onchange="setTheme(this.value)" id="theme-select" class="form-input py-1.5 px-3 w-28 text-xs font-bold cursor-pointer hidden sm:block"><option value="light">Light</option><option value="midnight">Midnight</option><option value="dark">Dark</option></select>
                <div class="h-6 w-[1px] bg-[var(--border-color)] mx-1"></div>
                <button onclick="openAddEntry()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm"><i class="fas fa-plus"></i> <span class="hidden sm:inline">Add</span></button>
                <button onclick="toggleSettings()" class="btn-secondary w-9 h-9 rounded-lg flex items-center justify-center"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 relative">
            
            <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card p-5">
                        <div class="flex justify-between items-start">
                            <p class="text-xs font-bold text-[var(--text-secondary)] uppercase" id="lbl-balance-title">Current Balance</p>
                            <span id="bal-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-[var(--be-bg)] text-[var(--text-secondary)]">0%</span>
                        </div>
                        <div id="kpi-balance-wrapper"><h3 class="text-2xl font-bold mt-1" id="kpi-balance">$0.00</h3></div>
                        <div class="h-1 w-full bg-[var(--border-color)] mt-3 rounded overflow-hidden"><div class="h-full bg-[var(--accent-color)]" style="width: 100%"></div></div>
                    </div>
                    <div class="card p-5"><p class="text-xs font-bold text-[var(--text-secondary)] uppercase">Trading PnL (Period)</p><div id="kpi-pnl-wrapper"><h3 class="text-2xl font-bold mt-1" id="kpi-pnl">$0.00</h3></div></div>
                    <div class="card p-5"><p class="text-xs font-bold text-[var(--text-secondary)] uppercase">Win Rate</p><h3 class="text-2xl font-bold mt-1" id="kpi-winrate">0%</h3><div class="h-1 w-full bg-[var(--border-color)] mt-3 rounded overflow-hidden"><div class="h-full bg-[var(--success)]" id="bar-winrate" style="width: 0%"></div></div></div>
                    <div class="card p-5"><p class="text-xs font-bold text-[var(--text-secondary)] uppercase">Avg RR</p><h3 class="text-2xl font-bold mt-1" id="kpi-rr">0.00 RR</h3></div>
                </div>
                <div class="card overflow-hidden flex flex-col" style="max-height: 450px;">
                    <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center bg-[var(--input-bg)]"><h3 class="font-bold text-sm uppercase text-[var(--text-secondary)]">Trading Logs & Transaction History</h3><span class="text-xs text-[var(--text-secondary)]" id="trade-count">0 Records</span></div>
                    <div class="overflow-auto flex-1 w-full"><table class="w-full"><thead class="bg-[var(--input-bg)] sticky top-0 z-10"><tr><th>Date</th><th>Type/Pair</th><th>Side</th><th>Setup</th><th>Key Lvl</th><th>Size</th><th>Risk</th><th>RR</th><th>Result</th><th class="text-right">Fee</th><th class="text-right">Net PnL</th><th class="text-center">Act</th></tr></thead><tbody id="table-body"></tbody></table><div id="empty-state" class="hidden py-12 text-center text-[var(--text-secondary)]"><i class="fas fa-folder-open text-3xl mb-2 opacity-50"></i><p class="text-sm">No records found.</p></div></div>
                </div>
                <div class="card p-6 h-[500px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm uppercase text-[var(--text-secondary)]">Equity Curve (Time Weighted)</h3>
                        <div class="flex bg-[var(--input-bg)] p-1 rounded-lg">
                            <button onclick="filterChart('7D')" id="chart-btn-7d" class="px-3 py-1 text-xs font-bold rounded text-[var(--text-secondary)] transition">7D</button>
                            <button onclick="filterChart('1M')" id="chart-btn-1m" class="px-3 py-1 text-xs font-bold rounded text-[var(--text-secondary)] transition">1M</button>
                            <button onclick="filterChart('ALL')" id="chart-btn-all" class="px-3 py-1 text-xs font-bold rounded chart-btn-active transition">ALL</button>
                        </div>
                    </div>
                    <div class="flex-1 w-full relative">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="hidden h-full flex gap-6">
                <div class="flex-1 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold" id="cal-title">Month Year</h3><div class="flex gap-2"><button onclick="moveMonth(-1)" class="btn-secondary px-3 py-1 rounded"><i class="fas fa-chevron-left"></i></button><button onclick="moveMonth(0)" class="btn-secondary px-3 py-1 rounded text-xs font-bold">Today</button><button onclick="moveMonth(1)" class="btn-secondary px-3 py-1 rounded"><i class="fas fa-chevron-right"></i></button></div></div>
                    <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-[var(--text-secondary)] uppercase"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="cal-grid" class="grid grid-cols-7 gap-2 flex-1 auto-rows-fr"></div>
                </div>
                <div class="w-80 flex-shrink-0 flex flex-col gap-4 overflow-y-auto">
                    <div class="card p-5">
                        <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-4 border-b border-[var(--border-color)] pb-2">Monthly Stats</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between"><span class="text-sm text-[var(--text-secondary)]">Net PnL</span><span class="text-sm font-bold" id="m-pnl">$0.00</span></div>
                            <div class="flex justify-between"><span class="text-sm text-[var(--text-secondary)]">Converted</span><span class="text-sm font-bold text-[var(--accent-color)]" id="m-bdt">৳0</span></div>
                            <div class="flex justify-between"><span class="text-sm text-[var(--text-secondary)]">Total RR</span><span class="text-sm font-bold" id="m-rr">0R</span></div>
                            <div class="flex justify-between"><span class="text-sm text-[var(--text-secondary)]">Total Trades</span><span class="text-sm font-bold" id="m-trades">0</span></div>
                        </div>
                    </div>
                    <div class="card p-5 flex-1">
                        <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-4 border-b border-[var(--border-color)] pb-2">Weekly Breakdown</h4>
                        <div id="weekly-list" class="space-y-3 overflow-y-auto">
                            </div>
                    </div>
                </div>
            </div>

            <div id="view-growth" class="hidden space-y-8 max-w-7xl mx-auto pb-10">
                
                <div class="card p-6 bg-[var(--input-bg)] border border-[var(--accent-color)] border-opacity-30">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold mb-1">Compounding Simulator</h2>
                            <p class="text-xs text-[var(--text-secondary)]">Automatic calculation with 0.1% Fee</p>
                        </div>
                        <div class="text-right">
                             <p class="text-xs font-bold uppercase text-[var(--text-secondary)]">Total Estimated Profit</p>
                             <p class="text-3xl font-bold text-[var(--success)]" id="grand-total-profit">$0.00</p>
                             <p class="text-sm font-bold text-[var(--text-secondary)] mt-1" id="grand-total-bdt">৳0</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6 overflow-hidden">
                    <div class="stage-header stage-1">
                        <div><h3 class="font-bold text-blue-500">STAGE 1: FOUNDATION</h3></div>
                        <div class="text-right"><p class="text-[10px] uppercase font-bold text-[var(--text-secondary)]">Stage Net</p><p class="text-sm font-bold text-blue-500" id="s1-net">$0.00</p></div>
                    </div>
                    <div class="grid grid-cols-5 gap-4 mb-4 p-4 bg-[var(--input-bg)] rounded-lg">
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Start Bal ($)</label><input type="number" id="s1-bal" value="380" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Risk ($)</label><input type="number" id="s1-risk" value="10" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Target RR</label><input type="number" id="s1-rr" value="2" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">SL (%)</label><input type="number" id="s1-sl" value="0.30" step="0.01" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Trades</label><input type="number" id="s1-cnt" value="0" class="form-input g-input" oninput="runSimulation()"></div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto"><table class="table-pro"><thead><tr><th>#</th><th>Type</th><th>Size</th><th>Fee (0.1%)</th><th>Net Profit</th><th>New Balance</th></tr></thead><tbody id="s1-body"></tbody></table></div>
                </div>

                <div class="card p-6 overflow-hidden">
                    <div class="stage-header stage-2">
                        <div><h3 class="font-bold text-purple-500">STAGE 2: ACCELERATION</h3></div>
                        <div class="text-right"><p class="text-[10px] uppercase font-bold text-[var(--text-secondary)]">Stage Net</p><p class="text-sm font-bold text-purple-500" id="s2-net">$0.00</p></div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 mb-4 p-4 bg-[var(--input-bg)] rounded-lg">
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Risk ($)</label><input type="number" id="s2-risk" value="20" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Target RR</label><input type="number" id="s2-rr" value="2" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">SL (%)</label><input type="number" id="s2-sl" value="0.30" step="0.01" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Trades</label><input type="number" id="s2-cnt" value="0" class="form-input g-input" oninput="runSimulation()"></div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto"><table class="table-pro"><thead><tr><th>#</th><th>Type</th><th>Size</th><th>Fee (0.1%)</th><th>Net Profit</th><th>New Balance</th></tr></thead><tbody id="s2-body"></tbody></table></div>
                </div>

                <div class="card p-6 overflow-hidden">
                    <div class="stage-header stage-3">
                        <div><h3 class="font-bold text-green-500">STAGE 3: CONSISTENCY</h3></div>
                        <div class="text-right"><p class="text-[10px] uppercase font-bold text-[var(--text-secondary)]">Stage Net</p><p class="text-sm font-bold text-green-500" id="s3-net">$0.00</p></div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 mb-4 p-4 bg-[var(--input-bg)] rounded-lg">
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Risk ($)</label><input type="number" id="s3-risk" value="30" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Target RR</label><input type="number" id="s3-rr" value="2" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">SL (%)</label><input type="number" id="s3-sl" value="0.30" step="0.01" class="form-input g-input" oninput="runSimulation()"></div>
                        <div><label class="text-[10px] font-bold opacity-50 uppercase text-[var(--text-secondary)]">Trades</label><input type="number" id="s3-cnt" value="0" class="form-input g-input" oninput="runSimulation()"></div>
                    </div>
                    <div class="overflow-x-auto max-h-60 overflow-y-auto"><table class="table-pro"><thead><tr><th>#</th><th>Type</th><th>Size</th><th>Fee (0.1%)</th><th>Net Profit</th><th>New Balance</th></tr></thead><tbody id="s3-body"></tbody></table></div>
                </div>
            </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="card w-full max-w-lg shadow-2xl">
            <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"><h3 class="font-bold text-lg">Entry Details</h3><button onclick="closeModal()" class="text-[var(--text-secondary)] hover:text-[var(--danger)]"><i class="fas fa-times"></i></button></div>
            <form id="trade-form" class="p-6 space-y-4">
                <input type="hidden" id="f-id">
                <div class="bg-[var(--input-bg)] p-1.5 rounded-lg flex gap-1 mb-2">
                    <button type="button" onclick="setEntryType('Trade')" id="type-trade" class="btn-toggle">Trading</button>
                    <button type="button" onclick="setEntryType('Deposit')" id="type-deposit" class="btn-toggle">Deposit</button>
                    <button type="button" onclick="setEntryType('Withdrawal')" id="type-withdraw" class="btn-toggle">Withdraw</button>
                </div>
                <input type="hidden" id="f-entry-type" value="Trade">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Date</label><input type="date" id="f-date" class="form-input" required></div>
                    <div class="trade-field"><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Pair</label><input type="text" id="f-pair" placeholder="BTC" class="form-input uppercase font-bold text-center"></div>
                    <div class="withdraw-field hidden"><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Description</label><input type="text" id="f-desc" placeholder="Details..." class="form-input"></div>
                </div>
                <div class="trade-field grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Side</label><select id="f-type" class="form-input"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Risk ($)</label><input type="number" id="f-risk" placeholder="50" class="form-input font-bold" oninput="calcLogic()"></div>
                </div>
                <div class="trade-field grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Setup</label><select id="f-setup" class="form-input"><option value="Reversal">Reversal</option><option value="Continuation">Continuation</option></select></div>
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Key Level</label><select id="f-keylevel" class="form-input"><option value="FVG">FVG</option><option value="Swing Point">Swing Point</option></select></div>
                </div>
                <div class="trade-field bg-[var(--accent-bg)] p-4 rounded-lg border border-[var(--accent-color)] border-opacity-20">
                    <div class="flex justify-between mb-2"><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase">Stop Loss (%)</label><span class="text-[10px] text-[var(--accent-color)]">Fee: 0.1% of Size</span></div>
                    <input type="number" step="0.01" id="f-sl" placeholder="0.5" class="form-input mb-3" oninput="calcLogic()">
                    <div class="flex justify-between items-center text-xs"><span class="text-[var(--text-secondary)]">Size:</span><span class="font-mono font-bold text-[var(--accent-color)] text-lg" id="view-size">$0</span><input type="hidden" id="f-size"></div>
                </div>
                <div class="trade-field grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Result</label><select id="f-result" class="form-input" onchange="calcLogic()"><option value="Select">Active</option><option value="Win">Win</option><option value="Loss">Loss</option><option value="BE">Break Even</option></select></div>
                    <div><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">RR</label><input type="number" step="0.1" id="f-rr" placeholder="2" class="form-input text-center" oninput="calcLogic()"></div>
                </div>
                <div class="withdraw-field hidden"><label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase block">Amount ($)</label><input type="number" id="f-amount" placeholder="100" class="form-input text-xl font-bold" oninput="calcWithdrawal()"></div>
                <div class="flex justify-between items-center p-3 bg-[var(--input-bg)] rounded border border-[var(--border-color)]">
                    <div class="flex flex-col"><span class="text-xs font-bold text-[var(--text-secondary)]">NET Change</span></div><span class="text-xl font-bold font-mono" id="view-pnl">$0.00</span><input type="hidden" id="f-pnl"><input type="hidden" id="f-fees">
                </div>
                <button type="submit" id="saveBtn" class="btn-primary w-full py-3 rounded-lg font-bold shadow-lg">Save Record</button>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4">
        <div class="card w-full max-w-sm p-6">
            <h3 class="font-bold mb-4">Settings</h3>
            <label class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-1 block">Initial Capital</label>
            <input type="number" id="set-balance" class="form-input mb-4">
            <div class="flex gap-2"><button onclick="saveSettings()" class="btn-primary flex-1 py-2 rounded">Save</button><button onclick="toggleSettings()" class="btn-secondary flex-1 py-2 rounded">Cancel</button></div>
            <button onclick="wipeData()" class="text-[var(--danger)] text-xs mt-4 text-center w-full hover:underline">Reset All Data</button>
        </div>
    </div>

    <script>
        // --- INITIALIZATION ---
        let db = JSON.parse(localStorage.getItem('rashik_v38')) || { trades: [], config: { balance: 10000, theme: 'light', bdt: 125 } };
        if (!db.config.bdt) db.config.bdt = 125;
        let calDate = new Date(); let chartObj = null; let isPnLVisible = true; 
        let currentFilter = 'THIS_MONTH'; let chartRange = 'ALL'; let entryType = 'Trade';

        document.addEventListener('DOMContentLoaded', () => {
            setTheme(db.config.theme); 
            document.getElementById('theme-select').value = db.config.theme;
            document.getElementById('bdt-rate').value = db.config.bdt;
            document.getElementById('dashboard-filter').value = currentFilter;
            document.getElementById('f-date').valueAsDate = new Date();
            refreshUI();
            runSimulation();
        });

        // --- UTILS ---
        function updateBDT(val) { db.config.bdt = parseFloat(val); saveDB(); refreshUI(); runSimulation(); }
        function setTheme(n){ document.documentElement.className=n; db.config.theme=n; saveDB(); if(chartObj) renderChart(); }
        function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
        
        function switchTab(t){
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+t).classList.add('active');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-calendar').classList.add('hidden');
            document.getElementById('view-growth').classList.add('hidden');
            document.getElementById('view-'+t).classList.remove('hidden');
            if(t==='calendar') renderCalendar();
            if(t==='growth') runSimulation();
            if(t==='dashboard') { document.getElementById('dashboard-controls').classList.remove('hidden'); setTimeout(() => renderChart(), 100); } 
            else { document.getElementById('dashboard-controls').classList.add('hidden'); }
            document.getElementById('page-title').innerText = t === 'growth' ? 'Compounding Simulator' : (t === 'calendar' ? 'Trading Calendar' : 'Dashboard Overview');
            // Close sidebar on mobile after click
            if(window.innerWidth < 768) toggleSidebar();
        }

        function formatDouble(usd) {
            if (!isPnLVisible) return '****';
            const val = parseFloat(usd);
            const bdt = val * db.config.bdt;
            const sign = val >= 0 ? '+' : '';
            return `<div>${sign}$${val.toLocaleString(undefined, {minimumFractionDigits: 2})}</div><div class="sub-curr">৳ ${Math.round(bdt).toLocaleString()}</div>`;
        }
        function formatSimple(usd) { if(!isPnLVisible) return '****'; return `$${parseFloat(usd).toLocaleString()}`; }
        function updateDashboardFilter(v) { currentFilter = v; refreshUI(); }
        function togglePrivacy() { isPnLVisible = !isPnLVisible; document.getElementById('btn-privacy').innerHTML = isPnLVisible ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>'; refreshUI(); }

        // --- CORE LOGIC: PROFESSIONAL CALCS & ANCHORING ---
        function getFilteredStats() {
            let now = new Date();
            let startDate = new Date(0); // Epoch
            
            if (currentFilter === 'THIS_MONTH') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (currentFilter === 'LAST_MONTH') {
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            }

            // 1. Calculate Balance Before Period Starts (The Anchor)
            let anchorBalance = parseFloat(db.config.balance);
            // All transactions before Start Date affect Anchor Balance
            db.trades.filter(t => new Date(t.date) < startDate).forEach(t => anchorBalance += t.pnl);

            // 2. Get Period Trades (Sorted by Date AND ID for serial accuracy)
            let periodTrades = db.trades.filter(t => {
                let d = new Date(t.date);
                if(currentFilter === 'LAST_MONTH') {
                    let endLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    return d >= startDate && d <= endLastMonth;
                }
                return d >= startDate;
            }).sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id); // Latest first for Table

            return { anchorBalance, periodTrades, startDate };
        }

        function refreshUI() {
            const { anchorBalance, periodTrades } = getFilteredStats();
            renderKPI(anchorBalance, periodTrades);
            renderTable(periodTrades);
            renderChart();
            renderCalendar();
        }

        function renderKPI(anchorBalance, trades) {
            let periodPnL = 0; // Net change in equity (Trading + Deposits)
            let tradingPnL = 0; // Only Trading PnL
            let wins = 0, count = 0, totalRR = 0;
            
            trades.forEach(t => {
                periodPnL += t.pnl;
                if(t.isTrade) {
                    tradingPnL += t.pnl;
                    count++;
                    if(t.result === 'Win') wins++;
                    if(t.rr) totalRR += t.rr;
                }
            });

            // Current Balance = Anchor + Net Change
            let currentDisplayBalance = anchorBalance + periodPnL;
            
            // PROFESSIONAL GROWTH FORMULA:
            let growthPct = 0;
            if(anchorBalance > 0) growthPct = (tradingPnL / anchorBalance) * 100;

            document.getElementById('lbl-balance-title').innerText = currentFilter === 'ALL' ? 'Current Equity' : 'Period End Equity';
            document.getElementById('kpi-balance').innerHTML = formatDouble(currentDisplayBalance);
            
            const badge = document.getElementById('bal-badge');
            badge.innerText = (growthPct >= 0 ? '+' : '') + growthPct.toFixed(2) + '%';
            badge.className = `px-2 py-0.5 rounded text-[10px] font-bold ${growthPct >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;

            document.getElementById('kpi-pnl').innerHTML = formatDouble(tradingPnL); // Strict Trading PnL
            document.getElementById('kpi-pnl').className = `text-2xl font-bold mt-1 ${tradingPnL>=0?'text-green-500':'text-red-500'}`;
            
            document.getElementById('kpi-winrate').innerText = count ? ((wins/count)*100).toFixed(1)+'%' : '0%';
            document.getElementById('bar-winrate').style.width = count ? ((wins/count)*100)+'%' : '0%';
            
            let avgRR = count ? (totalRR / count).toFixed(2) : '0.00';
            document.getElementById('kpi-rr').innerText = avgRR + ' RR';
            document.getElementById('trade-count').innerText = `${trades.length} Records`;
        }

        function renderTable(trades) {
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            if(!trades.length) { document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');

            trades.forEach(t => {
                const tr = document.createElement('tr');
                const pnlHTML = formatDouble(t.pnl);
                let typeHtml = '';
                if (t.isTrade) {
                    let badge = t.result==='Win'?'res-win':(t.result==='Loss'?'res-loss':'res-be');
                    let icon = t.result==='Win'?'check':(t.result==='Loss'?'times':'minus');
                    typeHtml = `<td class="font-bold">${t.pair}</td><td class="text-xs font-bold ${t.type==='Long'?'text-green-500':'text-red-500'}">${t.type}</td><td class="text-xs">${t.setup}</td><td class="text-xs text-[var(--text-secondary)]">${t.keyLevel}</td><td class="font-mono text-xs">${isPnLVisible?'$'+Math.round(t.size):'**'}</td><td class="font-bold text-orange-400">${isPnLVisible?'$'+t.risk:'**'}</td><td class="text-[var(--accent-color)] font-bold">1:${t.rr}</td><td><div class="res-badge ${badge}"><i class="fas fa-${icon}"></i> ${t.result}</div></td><td class="text-right text-xs text-[var(--text-secondary)]">${isPnLVisible?'-$'+t.fees.toFixed(2):'**'}</td>`;
                } else {
                    let label = t.pnl >= 0 ? '<span class="text-green-500 font-bold"><i class="fas fa-arrow-down mr-1"></i> DEPOSIT</span>' : '<span class="text-red-500 font-bold"><i class="fas fa-arrow-up mr-1"></i> WITHDRAW</span>';
                    typeHtml = `<td colspan="8" class="text-sm font-medium pl-4">${label} <span class="text-[var(--text-secondary)] mx-2">|</span> ${t.setup}</td><td class="text-right">-</td>`;
                }
                tr.innerHTML = `<td class="text-[var(--text-secondary)]">${t.date}</td>${typeHtml}<td class="text-right font-mono font-bold ${t.pnl>=0?'text-green-500':'text-red-500'}">${pnlHTML}</td><td class="text-center"><div class="flex justify-center gap-2"><button onclick="editTrade(${t.id})" class="text-blue-500"><i class="fas fa-pen"></i></button><button onclick="delTrade(${t.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- CHART: DAILY TIME SERIES LOGIC (FLAT LINES FIX) ---
        function filterChart(range) {
            chartRange = range;
            document.querySelectorAll('[id^="chart-btn-"]').forEach(b => b.classList.remove('chart-btn-active'));
            document.getElementById('chart-btn-'+range.toLowerCase()).classList.add('chart-btn-active');
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('equityChart').getContext('2d'); 
            if(chartObj) chartObj.destroy();
            
            let allTrades = [...db.trades].sort((a,b)=> new Date(a.date) - new Date(b.date) || a.id - b.id);
            let startDate = new Date(db.trades.length ? db.trades[0].date : new Date()); // Default to first trade ever
            let now = new Date();

            // Determine Start Date based on Filter
            if (chartRange === '7D') { startDate = new Date(); startDate.setDate(now.getDate() - 7); }
            else if (chartRange === '1M') { startDate = new Date(); startDate.setDate(now.getDate() - 30); }
            else { startDate = new Date(db.trades.length ? db.trades[0].date : new Date()); } // All time

            // Calculate Initial Balance BEFORE the start date (The Anchor)
            let runningBalance = parseFloat(db.config.balance);
            allTrades.filter(t => new Date(t.date) < startDate).forEach(t => runningBalance += t.pnl);

            // Generate Daily Data Points (Time Series)
            let dataPoints = [];
            let labels = [];
            
            // Loop from Start Date to Today
            let loopDate = new Date(startDate);
            loopDate.setHours(0,0,0,0); // Normalize time
            let today = new Date(); today.setHours(0,0,0,0);

            // If start date is after today (no trades yet), just show today
            if(loopDate > today) loopDate = today;

            while(loopDate <= today) {
                // Find trades that happened ON this specific loopDate
                let dayTrades = allTrades.filter(t => {
                    let tDate = new Date(t.date);
                    tDate.setHours(0,0,0,0);
                    return tDate.getTime() === loopDate.getTime();
                });

                // Apply PnL for that day
                dayTrades.forEach(t => runningBalance += t.pnl);

                // Push EOD Balance
                dataPoints.push(runningBalance);
                labels.push(loopDate.getDate() + '/' + (loopDate.getMonth()+1));

                // Next Day
                loopDate.setDate(loopDate.getDate() + 1);
            }
            
            const grad=ctx.createLinearGradient(0,0,0,400); grad.addColorStop(0,'rgba(99,102,241,0.5)'); grad.addColorStop(1,'rgba(99,102,241,0)');
            
            chartObj=new Chart(ctx,{
                type:'line',
                data:{ labels:labels, datasets:[{ data: dataPoints, borderColor: db.config.theme === 'dark' ? '#3b82f6' : '#6366f1', backgroundColor: grad, fill: true, tension: 0.1, pointRadius: 2, hoverRadius: 5 }] },
                options:{ responsive: true, maintainAspectRatio: false, plugins:{legend:false, tooltip: {intersect: false, mode: 'index'}}, scales:{ x:{grid:{display:false}}, y:{grid:{color:db.config.theme==='light'?'#e5e7eb':'#334155'}} } }
            });
        }

        // --- CALENDAR & OTHER UTILS ---
        function renderCalendar() {
            const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
            const y = calDate.getFullYear(), m = calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m).toLocaleString('default',{month:'long',year:'numeric'});
            const first = new Date(y,m,1).getDay(), days = new Date(y,m+1,0).getDate();
            
            // Aggregate Daily Data correctly
            const map={}; 
            db.trades.filter(t=> t.isTrade === true && new Date(t.date).getMonth()===m && new Date(t.date).getFullYear()===y).forEach(t=>{ 
                const d=new Date(t.date).getDate(); 
                if(!map[d])map[d]={pnl:0,rr:0}; 
                map[d].pnl+=t.pnl; 
                if(t.result==='Win')map[d].rr+=t.rr; 
            });
            
            for(let i=0; i<first; i++) grid.innerHTML+=`<div class="bg-transparent"></div>`;
            for(let i=1; i<=days; i++) {
                const d=map[i]; let html=''; let bg='cal-box';
                if(d) {
                    if(d.pnl>0) { bg+=' cal-win'; html=`<span class="text-sm font-bold text-green-500">${formatSimple(d.pnl)}</span><div class="res-badge res-win mt-1">${d.rr.toFixed(1)}R</div>`; }
                    else if(d.pnl<0) { bg+=' cal-loss'; html=`<span class="text-sm font-bold text-red-500">${formatSimple(d.pnl)}</span><div class="res-badge res-loss mt-1">✖️</div>`; }
                    else { bg+=' cal-be'; html=`<span class="text-sm font-bold text-gray-500">$0</span><div class="res-badge res-be mt-1">➖</div>`; }
                }
                grid.innerHTML+=`<div class="${bg}"><span class="absolute top-1 right-2 text-[10px] font-bold opacity-50">${i}</span><div class="flex flex-col items-center justify-center h-full pt-3">${html}</div></div>`;
            }
            updateCalendarSidebar(db.trades.filter(t=> t.isTrade === true && new Date(t.date).getMonth()===m && new Date(t.date).getFullYear()===y));
        }

        function updateCalendarSidebar(trades) {
            let mPnL = 0, mRR = 0, mCount = 0; let weeks = {};
            trades.forEach(t => { mPnL += t.pnl; mCount++; mRR += (t.rr || 0); const d = new Date(t.date); const w = Math.ceil((d.getDate() - 1 - d.getDay()) / 7); if(!weeks[w]) weeks[w] = 0; weeks[w] += t.pnl; });
            document.getElementById('m-pnl').innerHTML = isPnLVisible ? `$${mPnL.toFixed(2)}` : '****';
            document.getElementById('m-pnl').className = `text-sm font-bold ${mPnL>=0 ? 'text-green-500':'text-red-500'}`;
            document.getElementById('m-bdt').innerText = isPnLVisible ? `৳${Math.round(mPnL * db.config.bdt).toLocaleString()}` : '****';
            document.getElementById('m-rr').innerText = mRR.toFixed(1) + 'R';
            document.getElementById('m-trades').innerText = mCount;
            const wList = document.getElementById('weekly-list'); wList.innerHTML = '';
            Object.keys(weeks).sort().forEach(w => { wList.innerHTML += `<div class="flex justify-between items-center p-2 bg-[var(--input-bg)] rounded"><span class="text-xs text-[var(--text-secondary)]">Week ${parseInt(w)+1}</span><span class="text-xs font-bold ${weeks[w]>=0?'text-green-500':'text-red-500'}">${isPnLVisible ? '$'+weeks[w].toFixed(2) : '****'}</span></div>`; });
        }

        function runSimulation() {
            let bal = parseFloat(document.getElementById('s1-bal').value) || 0;
            let grandProfit = 0;
            bal = simulateStage(1, bal);
            bal = simulateStage(2, bal);
            bal = simulateStage(3, bal);
            let startBal = parseFloat(document.getElementById('s1-bal').value) || 0;
            grandProfit = bal - startBal;
            document.getElementById('grand-total-profit').innerText = `$${grandProfit.toFixed(2)}`;
            document.getElementById('grand-total-bdt').innerText = `৳${Math.round(grandProfit * db.config.bdt).toLocaleString()}`;
        }

        function simulateStage(num, startBal) {
            const risk = parseFloat(document.getElementById(`s${num}-risk`).value) || 0;
            const rr = parseFloat(document.getElementById(`s${num}-rr`).value) || 0;
            const sl = parseFloat(document.getElementById(`s${num}-sl`).value) || 0;
            const cnt = parseInt(document.getElementById(`s${num}-cnt`).value) || 0;
            const tbody = document.getElementById(`s${num}-body`);
            const netDisplay = document.getElementById(`s${num}-net`);
            
            tbody.innerHTML = '';
            let currentBal = startBal;
            let stageStartBal = startBal;
            const size = (sl > 0) ? (risk * 100) / sl : 0;
            const fee = size * 0.001; 
            const netWin = (risk * rr) - fee;

            for(let i=1; i<=cnt; i++) {
                currentBal += netWin;
                tbody.innerHTML += `<tr><td class="text-[var(--text-secondary)] font-mono">${i}</td><td class="text-green-500 font-bold text-xs">Simulated Win</td><td class="font-mono text-xs">$${Math.round(size)}</td><td class="text-red-400 font-mono text-xs">-$${fee.toFixed(2)}</td><td class="text-[var(--accent-color)] font-bold text-xs">+$${netWin.toFixed(2)}</td><td class="font-bold text-xs">$${currentBal.toFixed(2)}</td></tr>`;
            }
            let profit = currentBal - stageStartBal;
            netDisplay.innerText = `$${profit.toFixed(2)}`;
            return currentBal;
        }

        // --- FORM & MODAL HANDLERS ---
        function setEntryType(t) {
            entryType = t; document.getElementById('f-entry-type').value = t;
            document.getElementById('type-trade').className = 'btn-toggle'; document.getElementById('type-deposit').className = 'btn-toggle'; document.getElementById('type-withdraw').className = 'btn-toggle';
            if(t === 'Trade'){ document.getElementById('type-trade').classList.add('btn-toggle-active'); document.querySelectorAll('.trade-field').forEach(e=>e.classList.remove('hidden')); document.querySelectorAll('.withdraw-field').forEach(e=>e.classList.add('hidden')); calcLogic(); } 
            else { if(t === 'Deposit') document.getElementById('type-deposit').classList.add('btn-toggle-active-deposit'); else document.getElementById('type-withdraw').classList.add('btn-toggle-active-withdraw'); document.querySelectorAll('.trade-field').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.withdraw-field').forEach(e=>e.classList.remove('hidden')); calcWithdrawal(); }
        }
        function calcLogic() { if(entryType!=='Trade') return; const r=parseFloat(document.getElementById('f-risk').value)||0, sl=parseFloat(document.getElementById('f-sl').value)||0, rr=parseFloat(document.getElementById('f-rr').value)||0, res=document.getElementById('f-result').value; let sz=sl>0?(r*100)/sl:0; document.getElementById('view-size').innerText='$'+Math.round(sz); document.getElementById('f-size').value=sz; let net=0, fee=sz*0.001; if(res==='Win') { net=(r*rr)-fee; } else if(res==='Loss') { net=-r-fee; } else if(res==='BE') { net=-fee; } document.getElementById('f-fees').value=fee.toFixed(2); document.getElementById('f-pnl').value=net; document.getElementById('view-pnl').innerText=(net>=0?'+':'')+net.toFixed(2); }
        function calcWithdrawal() { if(entryType === 'Trade') return; const a = parseFloat(document.getElementById('f-amount').value)||0; let finalPnL = entryType === 'Deposit' ? a : -a; document.getElementById('view-pnl').innerText = (finalPnL>=0?'+':'') + finalPnL.toFixed(2); document.getElementById('f-pnl').value = finalPnL; }
        
        document.getElementById('trade-form').addEventListener('submit',e=>{ e.preventDefault(); const id=document.getElementById('f-id').value, d=document.getElementById('f-date').value, pnl=parseFloat(document.getElementById('f-pnl').value); let t={id:id?parseInt(id):Date.now(),date:d,pnl:pnl}; if(entryType==='Trade'){ t.isTrade=true; t.pair=document.getElementById('f-pair').value.toUpperCase()+'/USDT'; t.type=document.getElementById('f-type').value; t.risk=parseFloat(document.getElementById('f-risk').value); t.rr=parseFloat(document.getElementById('f-rr').value); t.result=document.getElementById('f-result').value; t.setup=document.getElementById('f-setup').value; t.keyLevel=document.getElementById('f-keylevel').value; t.size=parseFloat(document.getElementById('f-size').value); t.fees=parseFloat(document.getElementById('f-fees').value); } else { t.isTrade=false; t.pair = entryType.toUpperCase(); t.setup=document.getElementById('f-desc').value; t.keyLevel='-'; t.rr=0; t.result='-'; t.fees=0; } if(id){db.trades[db.trades.findIndex(x=>x.id==id)]=t;}else{db.trades.push(t);} saveDB(); refreshUI(); closeModal(); });
        
        function openAddEntry(){ resetForm(); document.getElementById('modal').classList.remove('hidden'); }
        function closeModal(){document.getElementById('modal').classList.add('hidden');}
        function resetForm(){document.getElementById('trade-form').reset(); document.getElementById('f-id').value=''; document.getElementById('f-date').valueAsDate=new Date(); setEntryType('Trade');}
        function editTrade(id) { const t = db.trades.find(x => x.id === id); if (!t) return; document.getElementById('f-id').value = t.id; document.getElementById('f-date').value = t.date; if(t.isTrade) { setEntryType('Trade'); document.getElementById('f-pair').value = t.pair.split('/')[0]; document.getElementById('f-type').value = t.type; document.getElementById('f-risk').value = t.risk; document.getElementById('f-rr').value = t.rr; document.getElementById('f-setup').value = t.setup; document.getElementById('f-keylevel').value = t.keyLevel; document.getElementById('f-sl').value = ((t.risk * 100) / t.size).toFixed(2); document.getElementById('f-result').value = t.result; calcLogic(); } else { if(t.pnl >= 0) setEntryType('Deposit'); else setEntryType('Withdrawal'); document.getElementById('f-desc').value = t.setup; document.getElementById('f-amount').value = Math.abs(t.pnl); calcWithdrawal(); } document.getElementById('modal').classList.remove('hidden'); }
        function delTrade(id){if(confirm('Delete?')){db.trades=db.trades.filter(x=>x.id!==id);saveDB();refreshUI();}}
        function saveDB(){localStorage.setItem('rashik_v38',JSON.stringify(db));}
        function saveSettings(){db.config.balance=parseFloat(document.getElementById('set-balance').value); saveDB(); refreshUI(); toggleSettings();}
        function toggleSettings(){document.getElementById('settings-modal').classList.toggle('hidden'); document.getElementById('set-balance').value=db.config.balance;}
        function wipeData(){if(confirm('Reset?')){localStorage.removeItem('rashik_v38');location.reload();}}
        function moveMonth(n){calDate.setMonth(calDate.getMonth()+n);renderCalendar();}
        function exportData(){/* kept simple */ const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(db.trades); XLSX.utils.book_append_sheet(wb, ws, "Trades"); XLSX.writeFile(wb, "Journal.xlsx");}
    </script>
</body>
</html>